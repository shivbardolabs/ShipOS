generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // Pooled connection via Vercel Postgres
  directUrl = env("POSTGRES_URL_NON_POOLING") // Direct connection for migrations
}

// ── Tenancy ──────────────────────────────────────────────────────────────────

model Tenant {
  id            String   @id @default(cuid())
  name          String   // Store / business name
  slug          String   @unique // URL-friendly identifier
  address       String?
  city          String?
  state         String?
  zipCode       String?
  country       String   @default("US")
  phone         String?
  email         String?
  timezone      String   @default("America/New_York")
  businessHours String?  // JSON: { mon: { open, close }, tue: … }
  taxRate       Float    @default(0)
  logoUrl       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  users       User[]
  customers   Customer[]
  invitations Invitation[]
}

// ── Users & Roles ────────────────────────────────────────────────────────────

model User {
  id          String    @id @default(cuid())
  auth0Id     String?   @unique // Auth0 `sub` claim — links login to local user
  name        String
  email       String    @unique
  password    String    @default("")
  role        String    @default("admin") // superadmin, admin, manager, employee
  avatar      String?
  lastLoginAt DateTime? // Tracks most recent login
  loginCount  Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  auditLogs     AuditLog[]
  checkins      Package[]      @relation("CheckedInBy")
  checkouts     Package[]      @relation("CheckedOutBy")
  loginSessions LoginSession[]
}

// ── Login Session Tracking ───────────────────────────────────────────────────

model LoginSession {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  ipAddress String?
  userAgent String?
  loginAt   DateTime @default(now())
}

model Customer {
  id           String  @id @default(cuid())
  firstName    String
  lastName     String
  email        String?
  phone        String?
  businessName String?
  pmbNumber    String  @unique
  platform     String  @default("physical") // physical, iPostal, anytime, postscan
  status       String  @default("active") // active, closed, suspended

  dateOpened   DateTime  @default(now())
  dateClosed   DateTime?
  renewalDate  DateTime?
  billingTerms String?
  notes        String?

  // CMRA Compliance
  idType             String?   // drivers_license, passport, both
  idExpiration       DateTime?
  passportExpiration DateTime?
  form1583Status     String?   @default("pending") // pending, submitted, approved, expired
  form1583Date       DateTime?
  crdUploaded        Boolean   @default(false) // USPS CRD upload status
  crdUploadDate      DateTime?
  form1583Notarized  Boolean   @default(false)
  agreementSigned    Boolean   @default(false)
  agreementSignedAt  DateTime?

  // Home address (for Form 1583)
  homeAddress        String?
  homeCity           String?
  homeState          String?
  homeZip            String?

  // Notification preferences
  notifyEmail Boolean @default(true)
  notifySms   Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // soft delete

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  packages        Package[]
  mailPieces      MailPiece[]
  shipments       Shipment[]
  notifications   Notification[]
  shipToAddresses ShipToAddress[]
  loyaltyAccount  LoyaltyAccount?

  // Migration reference
  sourceId    String? // Original PostalMate CUSTOMERID
  migrationId String? // Links to MigrationRun
}

model Package {
  id             String  @id @default(cuid())
  trackingNumber String?
  carrier        String // amazon, ups, fedex, usps, dhl, walmart, target, other
  senderName     String?
  packageType    String  @default("medium") // letter, small, medium, large, oversized
  status         String  @default("checked_in") // checked_in, notified, ready, released, returned
  hazardous      Boolean @default(false)
  perishable     Boolean @default(false)
  notes          String?
  condition      String?

  // Fees
  storageFee   Float @default(0)
  receivingFee Float @default(0)
  quotaFee     Float @default(0)

  checkedInAt DateTime  @default(now())
  notifiedAt  DateTime?
  releasedAt  DateTime?

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  checkedInById String?
  checkedInBy   User?   @relation("CheckedInBy", fields: [checkedInById], references: [id])

  checkedOutById String?
  checkedOutBy   User?   @relation("CheckedOutBy", fields: [checkedOutById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Migration reference
  sourceId    String? // Original PostalMate PKGRECVXNID
  migrationId String? // Links to MigrationRun
}

model MailPiece {
  id        String  @id @default(cuid())
  type      String  @default("letter") // letter, magazine, catalog, legal, other
  sender    String?
  status    String  @default("received") // received, scanned, notified, held, forwarded, discarded
  scanImage String?
  action    String? // hold, forward, discard, open_scan
  notes     String?

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  receivedAt DateTime  @default(now())
  actionAt   DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model Shipment {
  id             String  @id @default(cuid())
  carrier        String
  service        String?
  trackingNumber String?
  destination    String?
  weight         Float?
  dimensions     String?

  wholesaleCost Float @default(0)
  retailPrice   Float @default(0)
  insuranceCost Float @default(0)
  packingCost   Float @default(0)

  status        String @default("pending") // pending, label_created, shipped, delivered, returned
  paymentStatus String @default("unpaid") // unpaid, paid, invoiced

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  shippedAt   DateTime?
  deliveredAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Migration reference
  sourceId    String? // Original PostalMate SHIPMENTXNID
  migrationId String? // Links to MigrationRun
}

model Notification {
  id      String  @id @default(cuid())
  type    String // package_checkin, package_reminder, id_expiration, mail_received, custom
  channel String // email, sms, both
  status  String  @default("pending") // pending, sent, delivered, failed, bounced
  subject String?
  body    String?

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  sentAt      DateTime?
  deliveredAt DateTime?
  createdAt   DateTime  @default(now())
}

model AuditLog {
  id         String  @id @default(cuid())
  action     String // package_checkin, package_release, customer_update, etc.
  entityType String // package, customer, shipment, etc.
  entityId   String
  details    String? // JSON string with change details

  userId String
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}

model CarrierRate {
  id            String   @id @default(cuid())
  carrier       String
  service       String
  addOnName     String?
  wholesaleRate Float
  retailRate    Float
  marginType    String   @default("markup") // markup, margin
  marginValue   Float    @default(0)
  isActive      Boolean  @default(true)
  lastUpdated   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model DropoffSetting {
  id                 String @id @default(cuid())
  carrier            String
  isEnabled          Boolean @default(false)
  compensationAmount Float   @default(0)
  retailCharge       Float   @default(0)
  department         String?
  credentials        String? // encrypted JSON
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique
  customerId    String?
  type          String // shipping, storage, service
  amount        Float
  tax           Float    @default(0)
  status        String   @default("draft") // draft, sent, paid, overdue, void
  dueDate       DateTime?
  paidAt        DateTime?
  items         String? // JSON string of line items
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Migration reference
  sourceId    String? // Original PostalMate CRTOTALXNID
  migrationId String? // Links to MigrationRun
}

model EndOfDayRecord {
  id           String   @id @default(cuid())
  date         DateTime
  carrier      String
  manifestId   String?
  packageCount Int      @default(0)
  status       String   @default("open") // open, picked_up, closed
  pickupTime   DateTime?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ── PostalMate Migration ─────────────────────────────────────────────────────

model MigrationRun {
  id            String   @id @default(cuid())
  sourceFile    String   // Original backup filename
  sourceSystem  String   @default("postalmate") // postalmate, other
  status        String   @default("pending") // pending, analyzing, migrating, completed, failed, rolled_back
  startedAt     DateTime?
  completedAt   DateTime?
  errorMessage  String?

  // Record counts from source
  sourceCustomers  Int @default(0)
  sourceShipments  Int @default(0)
  sourcePackages   Int @default(0)
  sourceProducts   Int @default(0)
  sourceInvoices   Int @default(0)
  sourceAddresses  Int @default(0)

  // Migrated counts
  migratedCustomers  Int @default(0)
  migratedShipments  Int @default(0)
  migratedPackages   Int @default(0)
  migratedProducts   Int @default(0)
  migratedInvoices   Int @default(0)
  migratedAddresses  Int @default(0)

  // Errors/skips
  errorLog      String? // JSON array of errors

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ShipToAddress {
  id           String  @id @default(cuid())
  firstName    String?
  lastName     String?
  companyName  String?
  contact      String?
  address1     String
  address2     String?
  address3     String?
  city         String?
  state        String?
  zipCode      String?
  zipPlus4     String?
  country      String  @default("US")
  email        String?
  phone        String?
  isCommercial Boolean @default(false)

  // Migration reference
  sourceId     String? // Original PostalMate SHIPTOID
  migrationId  String? // Links to MigrationRun

  customerId   String?
  customer     Customer? @relation(fields: [customerId], references: [id])

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ── Loyalty Program ──────────────────────────────────────────────────────────

model LoyaltyProgram {
  id              String   @id @default(cuid())
  name            String   @default("ShipOS Rewards")
  isActive        Boolean  @default(true)
  pointsPerDollar Float    @default(1)
  currencyName    String   @default("points")
  redemptionRate  Float    @default(0.05) // dollars per point (100 pts = $5 → 0.05)

  // Referral config
  referralEnabled       Boolean @default(true)
  referrerBonusPoints   Int     @default(200)
  refereeBonusPoints    Int     @default(100)

  tiers    LoyaltyTier[]
  rewards  LoyaltyReward[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LoyaltyTier {
  id                String  @id @default(cuid())
  name              String  // Bronze, Silver, Gold
  minPoints         Int     @default(0)
  maxPoints         Int?    // null = unlimited (top tier)
  earningMultiplier Float   @default(1.0)
  shippingDiscount  Float   @default(0) // percentage (e.g. 5 = 5%)
  freeHoldDays      Int     @default(0)
  benefits          String? // JSON array of benefit strings
  color             String  @default("#CD7F32")
  icon              String  @default("award")
  sortOrder         Int     @default(0)

  programId String
  program   LoyaltyProgram @relation(fields: [programId], references: [id])

  accounts LoyaltyAccount[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LoyaltyAccount {
  id             String   @id @default(cuid())
  currentPoints  Int      @default(0)
  lifetimePoints Int      @default(0)
  referralCode   String   @unique
  referredById   String?  // FK to another LoyaltyAccount

  customerId String   @unique
  customer   Customer @relation(fields: [customerId], references: [id])

  currentTierId String?
  currentTier   LoyaltyTier? @relation(fields: [currentTierId], references: [id])

  transactions LoyaltyTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LoyaltyTransaction {
  id           String @id @default(cuid())
  type         String // earn, redeem, expire, bonus, referral, adjustment
  points       Int    // positive for earn, negative for redeem
  balanceAfter Int
  description  String?
  referenceType String? // shipment, package, mailbox, invoice, referral, manual, reward
  referenceId   String?

  loyaltyAccountId String
  loyaltyAccount   LoyaltyAccount @relation(fields: [loyaltyAccountId], references: [id])

  createdAt DateTime @default(now())
}

model LoyaltyReward {
  id           String  @id @default(cuid())
  name         String
  description  String?
  pointsCost   Int
  rewardType   String  // discount, free_service, upgrade, credit, custom
  value        Float   @default(0) // dollar value of reward
  isActive     Boolean @default(true)
  maxRedemptions Int?  // null = unlimited

  programId String
  program   LoyaltyProgram @relation(fields: [programId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ── Mailbox Ranges ───────────────────────────────────────────────────────

model MailboxRange {
  id         String  @id @default(cuid())
  platform   String  // physical, anytime, iPostal, postscan
  label      String
  rangeStart Int
  rangeEnd   Int
  isActive   Boolean @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// ── Customer Documents (ID Scans) ────────────────────────────────────────

model CustomerDocument {
  id            String  @id @default(cuid())
  customerId    String
  type          String  // primary_id, secondary_id
  idTypeName    String  // e.g. "drivers_license", "passport"
  fileName      String
  fileUrl       String?
  extractedData String? // JSON: { fullName, address, idNumber, ... }
  expirationDate DateTime?
  uploadedAt    DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ── Mailbox Service Agreement ────────────────────────────────────────────

model MailboxAgreementTemplate {
  id        String  @id @default(cuid())
  name      String
  content   String  // Rich text / template with placeholders
  isDefault Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CustomerAgreement {
  id               String   @id @default(cuid())
  customerId       String
  templateId       String
  signedAt         DateTime?
  signatureDataUrl String?
  status           String   @default("draft") // draft, sent, signed, expired
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ── Invitations ──────────────────────────────────────────────────────────────

model Invitation {
  id        String   @id @default(cuid())
  email     String
  role      String   @default("employee") // admin, manager, employee
  status    String   @default("pending")  // pending, accepted, revoked
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  invitedBy String   // User ID of the admin who created the invite
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, tenantId])
}

// ── Feature Flags ────────────────────────────────────────────────────────────

model FeatureFlag {
  id             String   @id @default(cuid())
  key            String   @unique // e.g. "ai-smart-intake"
  name           String   // Human-readable name
  description    String?  // What this feature does
  category       String   @default("general") // ai, packages, operations, compliance, business, platform
  defaultEnabled Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  overrides FeatureFlagOverride[]
}

model FeatureFlagOverride {
  id         String      @id @default(cuid())
  flagId     String
  flag       FeatureFlag @relation(fields: [flagId], references: [id], onDelete: Cascade)
  targetType String      // 'user' | 'tenant'
  targetId   String      // user.id or tenant.id
  enabled    Boolean
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@unique([flagId, targetType, targetId])
}
