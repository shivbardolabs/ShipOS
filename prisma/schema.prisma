generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // Pooled connection via Vercel Postgres
  directUrl = env("POSTGRES_URL_NON_POOLING") // Direct connection for migrations
}

// ── Tenancy ──────────────────────────────────────────────────────────────────

model Tenant {
  id               String    @id @default(cuid())
  name             String    // Store / business name
  slug             String    @unique // URL-friendly identifier
  address          String?
  city             String?
  state            String?
  zipCode          String?
  country          String    @default("US")
  phone            String?
  email            String?
  timezone         String    @default("America/New_York")
  businessHours    String?   // JSON: { mon: { open, close }, tue: … }
  taxRate          Float     @default(0)
  logoUrl          String?
  status           String    @default("active") // active, paused, disabled, trial
  subscriptionTier String    @default("starter") // starter, pro, enterprise
  trialEndsAt      DateTime? // When trial period expires (null = no trial)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // White-Label Branding
  brandLogo        String? // URL to uploaded logo
  brandAccentColor String? // Hex color e.g. #6366f1
  brandTagline     String? // Custom tagline
  brandFavicon     String? // URL to favicon

  // Stripe integration
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?

  // Storage rate for package checkout (default $1/day after 30 days)
  storageRate          Float   @default(1.0)
  storageFreedays      Int     @default(30)
  storageCountWeekends Boolean @default(true) // Whether to count Sat/Sun in storage days

  // Receiving fee per package
  receivingFeeRate Float @default(3.0)

  // Package quota (monthly) — overage fee charged when exceeded
  packageQuota        Int   @default(0) // 0 = unlimited
  packageQuotaOverage Float @default(2.0) // Per-package overage fee

  // Payment methods enabled for checkout
  paymentMethods String? // JSON: { manual: bool, text2pay: bool, tapToGlass: bool, nfcReader: bool, cash: bool, postToAccount: bool }

  users              User[]
  customers          Customer[]
  invitations        Invitation[]
  stores             Store[]
  subscriptions      Subscription[]
  paymentRecords     PaymentRecord[]
  alerts             Alert[]
  carrierEnrollments CarrierProgramEnrollment[]
  storageLocations      StorageLocation[]
  billingModelConfig    BillingModelConfig?
  notificationTemplates NotificationTemplate[]
}

// ── Users & Roles ────────────────────────────────────────────────────────────

model User {
  id              String    @id @default(cuid())
  auth0Id         String?   @unique // Auth0 `sub` claim — links login to local user
  name            String
  email           String    @unique
  password        String    @default("")
  role            String    @default("admin") // superadmin, admin, manager, employee
  avatar          String?
  status          String    @default("active") // active, inactive, suspended
  deletedAt       DateTime? // Soft delete timestamp — filtered from queries when set
  agreedToTermsAt        DateTime? // When user accepted Terms of Service & Privacy Policy
  termsVersionAccepted   Int?      // Which version of ToS the user accepted
  privacyVersionAccepted Int?      // Which version of PP the user accepted
  mfaEnabled      Boolean   @default(false) // Whether user has MFA enrolled
  lastLoginAt     DateTime? // Tracks most recent login
  loginCount      Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  storeId String?
  store   Store? @relation(fields: [storeId], references: [id])

  auditLogs     AuditLog[]
  checkins      Package[]      @relation("CheckedInBy")
  checkouts     Package[]      @relation("CheckedOutBy")
  loginSessions LoginSession[]
}

// ── Login Session Tracking ───────────────────────────────────────────────────

model LoginSession {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  ipAddress     String?
  userAgent     String?
  success       Boolean  @default(true) // Whether login was successful
  failureReason String?  // Reason for failed login attempt
  loginAt       DateTime @default(now())
}

model Customer {
  id           String  @id @default(cuid())
  firstName    String
  lastName     String
  email        String?
  phone        String?
  businessName String?
  pmbNumber    String  @unique
  platform     String  @default("physical") // physical, iPostal, anytime, postscan
  status       String  @default("active") // active, closed, suspended

  dateOpened   DateTime  @default(now())
  dateClosed   DateTime?
  renewalDate  DateTime?
  billingTerms String?
  notes        String?

  // CMRA Compliance
  idType             String?   // drivers_license, passport, both
  idExpiration       DateTime?
  passportExpiration DateTime?
  form1583Status     String?   @default("pending") // pending, submitted, approved, expired
  form1583Date       DateTime?
  crdUploaded        Boolean   @default(false) // USPS CRD upload status
  crdUploadDate      DateTime?
  form1583Notarized  Boolean   @default(false)
  agreementSigned    Boolean   @default(false)
  agreementSignedAt  DateTime?

  // Proof of Address (CMRA requirement)
  proofOfAddressType        String?   // home_vehicle_insurance, mortgage_deed_of_trust, current_lease, state_drivers_nondriver_id, voter_id_card
  proofOfAddressDateOfIssue DateTime? // Date the proof-of-address document was issued
  proofOfAddressStatus      String?   @default("pending") // pending, submitted, approved, expired

  // Home address (for Form 1583)
  homeAddress        String?
  homeCity           String?
  homeState          String?
  homeZip            String?

  // Renewal tracking
  renewalStatus      String?   @default("current") // current, due_soon, past_due, suspended
  lastRenewalNotice  DateTime? // Last time a renewal notification was sent

  // SMS Compliance
  smsConsent         Boolean   @default(false)
  smsConsentAt       DateTime?
  smsOptOutAt        DateTime?
  smsConsentMethod   String?   // web_form, verbal, written

  // Stripe billing
  stripeCustomerId String? // For customer-facing billing

  // Encrypted PII
  ssn String? // AES-256-GCM encrypted SSN

  // Notification preferences
  notifyEmail Boolean @default(true)
  notifySms   Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // soft delete

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  storeId String?
  store   Store? @relation(fields: [storeId], references: [id])

  packages        Package[]
  mailPieces      MailPiece[]
  shipments       Shipment[]
  notifications   Notification[]
  shipToAddresses ShipToAddress[]
  loyaltyAccount  LoyaltyAccount?
  chargeEvents    ChargeEvent[]
  billingProfile  CustomerBillingProfile?

  // Migration reference
  sourceId    String? // Original PostalMate CUSTOMERID
  migrationId String? // Links to MigrationRun
}

model Package {
  id             String  @id @default(cuid())
  trackingNumber String?
  carrier        String // amazon, ups, fedex, usps, dhl, walmart, target, other
  senderName     String?
  packageType    String  @default("medium") // letter, small, medium, large, oversized
  status         String  @default("checked_in") // checked_in, notified, ready, released, returned, rts_initiated, rts_labeled, rts_completed
  hazardous      Boolean @default(false)
  perishable     Boolean @default(false)
  notes          String?
  condition      String?

  // Fees
  storageFee   Float @default(0)
  receivingFee Float @default(0)
  quotaFee     Float @default(0)

  storageLocation  String? // Physical shelf/bin location (e.g. "Shelf A3", "Bin 12")
  releaseSignature String? // Base64 data URL of customer signature on release

  checkedInAt DateTime  @default(now())
  notifiedAt  DateTime?
  releasedAt  DateTime?

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  checkedInById String?
  checkedInBy   User?   @relation("CheckedInBy", fields: [checkedInById], references: [id])

  checkedOutById String?
  checkedOutBy   User?   @relation("CheckedOutBy", fields: [checkedOutById], references: [id])

  storeId String?
  store   Store?  @relation(fields: [storeId], references: [id])

  // Pickup delegation
  delegateName String? // Name of person picking up on behalf of customer
  delegateIdType String? // Type of ID provided by delegate
  delegateIdNumber String? // ID number of delegate (encrypted)

  // Carrier Program (FedEx HAL / UPS Access Point)
  carrierProgram      String?  // fedex_hal, ups_access_point, null = regular PMB package
  recipientName       String?  // For carrier program packages (general public, not PMB holder)
  holdDeadline        DateTime? // Calculated hold period expiration (e.g. intake + 7 days)
  carrierUploadStatus String?  // pending, uploaded, confirmed, failed
  carrierUploadedAt   DateTime?
  carrierConfirmation String?  // Confirmation ID from carrier portal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Duplicate override (BAR-328)
  duplicateOverride          Boolean  @default(false) // True if user overrode duplicate warning
  duplicateOverrideReason    String?  // Reason for override (e.g. "Re-delivery", "Replacement")
  duplicateOriginalPackageId String?  // ID of the original package record

  // Migration reference
  sourceId    String? // Original PostalMate PKGRECVXNID
  migrationId String? // Links to MigrationRun

  // BAR-328: Index for fast duplicate tracking number lookups (< 500ms)
  @@index([trackingNumber])
}

model MailPiece {
  id        String  @id @default(cuid())
  type      String  @default("letter") // letter, magazine, catalog, legal, other
  sender    String?
  status    String  @default("received") // received, scanned, notified, held, forwarded, discarded
  scanImage     String?
  scanImageBack String? // Back of envelope scan for digital fulfillment
  action        String? // hold, forward, discard, open_scan
  notes         String?

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  receivedAt DateTime  @default(now())
  actionAt   DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model Shipment {
  id             String  @id @default(cuid())
  carrier        String
  service        String?
  trackingNumber String?
  destination    String?
  weight         Float?
  dimensions     String?

  wholesaleCost Float @default(0)
  retailPrice   Float @default(0)
  insuranceCost Float @default(0)
  packingCost   Float @default(0)

  status        String @default("pending") // pending, label_created, shipped, delivered, returned
  paymentStatus String @default("unpaid") // unpaid, paid, invoiced

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  shippedAt   DateTime?
  deliveredAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Migration reference
  sourceId    String? // Original PostalMate SHIPMENTXNID
  migrationId String? // Links to MigrationRun
}

model Notification {
  id      String  @id @default(cuid())
  type    String // package_checkin, package_reminder, id_expiration, mail_received, custom
  channel String // email, sms, both
  status  String  @default("pending") // pending, sent, delivered, failed, bounced
  subject String?
  body    String?

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  retryCount  Int       @default(0)
  lastRetryAt DateTime?
  sentAt      DateTime?
  deliveredAt DateTime?
  createdAt   DateTime  @default(now())
}

model NotificationTemplate {
  id          String  @id @default(cuid())
  type        String  @unique // package_checkin, package_reminder, id_expiration, mail_received, custom
  name        String  // Display name
  subject     String  // Email subject template (supports {{variables}})
  bodyHtml    String  // Email body HTML template
  bodySms     String  // SMS body template
  variables   String? // JSON array of available variable names
  isActive    Boolean @default(true)

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id         String  @id @default(cuid())
  action     String // package_checkin, package_release, customer_update, etc.
  entityType String // package, customer, shipment, etc.
  entityId   String
  details    String? // JSON string with change details
  oldData    String? // JSON snapshot of entity state before the change
  newData    String? // JSON snapshot of entity state after the change

  userId String
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}

model CarrierRate {
  id            String   @id @default(cuid())
  carrier       String
  service       String
  addOnName     String?
  wholesaleRate Float
  retailRate    Float
  marginType    String   @default("markup") // markup, margin
  marginValue   Float    @default(0)
  isActive      Boolean  @default(true)
  lastUpdated   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model DropoffSetting {
  id                 String @id @default(cuid())
  carrier            String
  isEnabled          Boolean @default(false)
  compensationAmount Float   @default(0)
  retailCharge       Float   @default(0)
  department         String?
  credentials        String? // encrypted JSON
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique
  tenantId      String?
  customerId    String?
  type          String // shipping, storage, service, tos_billing, monthly
  amount        Float
  tax           Float    @default(0)
  status        String   @default("draft") // draft, sent, paid, overdue, void, partially_paid
  dueDate       DateTime?
  paidAt        DateTime?
  items         String? // JSON string of line items (legacy)
  notes         String?

  // Payment tracking
  amountPaid      Float   @default(0)
  paymentMethodId String?
  paymentRef      String?

  // Delivery
  sentAt          DateTime?
  sentVia         String?   // email, in_app, print

  // Period covered
  periodStart     DateTime?
  periodEnd       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lineItems   InvoiceLineItem[]

  // Migration reference
  sourceId    String? // Original PostalMate CRTOTALXNID
  migrationId String? // Links to MigrationRun

  @@index([tenantId, customerId])
  @@index([tenantId, status])
  @@index([customerId, status])
}

model EndOfDayRecord {
  id           String   @id @default(cuid())
  date         DateTime
  carrier      String
  manifestId   String?
  packageCount Int      @default(0)
  status       String   @default("open") // open, picked_up, closed
  pickupTime   DateTime?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ── PostalMate Migration ─────────────────────────────────────────────────────

model MigrationRun {
  id            String   @id @default(cuid())
  sourceFile    String   // Original backup filename
  sourceSystem  String   @default("postalmate") // postalmate, other
  status        String   @default("pending") // pending, analyzing, migrating, completed, failed, rolled_back
  startedAt     DateTime?
  completedAt   DateTime?
  errorMessage  String?

  // Record counts from source
  sourceCustomers  Int @default(0)
  sourceShipments  Int @default(0)
  sourcePackages   Int @default(0)
  sourceProducts   Int @default(0)
  sourceInvoices   Int @default(0)
  sourceAddresses  Int @default(0)

  // Migrated counts
  migratedCustomers  Int @default(0)
  migratedShipments  Int @default(0)
  migratedPackages   Int @default(0)
  migratedProducts   Int @default(0)
  migratedInvoices   Int @default(0)
  migratedAddresses  Int @default(0)

  // Errors/skips
  errorLog      String? // JSON array of errors

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ShipToAddress {
  id           String  @id @default(cuid())
  firstName    String?
  lastName     String?
  companyName  String?
  contact      String?
  address1     String
  address2     String?
  address3     String?
  city         String?
  state        String?
  zipCode      String?
  zipPlus4     String?
  country      String  @default("US")
  email        String?
  phone        String?
  isCommercial Boolean @default(false)

  // Migration reference
  sourceId     String? // Original PostalMate SHIPTOID
  migrationId  String? // Links to MigrationRun

  customerId   String?
  customer     Customer? @relation(fields: [customerId], references: [id])

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ── Loyalty Program ──────────────────────────────────────────────────────────

model LoyaltyProgram {
  id              String   @id @default(cuid())
  name            String   @default("ShipOS Rewards")
  isActive        Boolean  @default(true)
  pointsPerDollar Float    @default(1)
  currencyName    String   @default("points")
  redemptionRate  Float    @default(0.05) // dollars per point (100 pts = $5 → 0.05)

  // Referral config
  referralEnabled       Boolean @default(true)
  referrerBonusPoints   Int     @default(200)
  refereeBonusPoints    Int     @default(100)

  tiers    LoyaltyTier[]
  rewards  LoyaltyReward[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LoyaltyTier {
  id                String  @id @default(cuid())
  name              String  // Bronze, Silver, Gold
  minPoints         Int     @default(0)
  maxPoints         Int?    // null = unlimited (top tier)
  earningMultiplier Float   @default(1.0)
  shippingDiscount  Float   @default(0) // percentage (e.g. 5 = 5%)
  freeHoldDays      Int     @default(0)
  benefits          String? // JSON array of benefit strings
  color             String  @default("#CD7F32")
  icon              String  @default("award")
  sortOrder         Int     @default(0)

  programId String
  program   LoyaltyProgram @relation(fields: [programId], references: [id])

  accounts LoyaltyAccount[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LoyaltyAccount {
  id             String   @id @default(cuid())
  currentPoints  Int      @default(0)
  lifetimePoints Int      @default(0)
  referralCode   String   @unique
  referredById   String?  // FK to another LoyaltyAccount

  customerId String   @unique
  customer   Customer @relation(fields: [customerId], references: [id])

  currentTierId String?
  currentTier   LoyaltyTier? @relation(fields: [currentTierId], references: [id])

  transactions LoyaltyTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LoyaltyTransaction {
  id           String @id @default(cuid())
  type         String // earn, redeem, expire, bonus, referral, adjustment
  points       Int    // positive for earn, negative for redeem
  balanceAfter Int
  description  String?
  referenceType String? // shipment, package, mailbox, invoice, referral, manual, reward
  referenceId   String?

  loyaltyAccountId String
  loyaltyAccount   LoyaltyAccount @relation(fields: [loyaltyAccountId], references: [id])

  createdAt DateTime @default(now())
}

model LoyaltyReward {
  id           String  @id @default(cuid())
  name         String
  description  String?
  pointsCost   Int
  rewardType   String  // discount, free_service, upgrade, credit, custom
  value        Float   @default(0) // dollar value of reward
  isActive     Boolean @default(true)
  maxRedemptions Int?  // null = unlimited

  programId String
  program   LoyaltyProgram @relation(fields: [programId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ── Mailbox Ranges ───────────────────────────────────────────────────────

model MailboxRange {
  id         String  @id @default(cuid())
  platform   String  // physical, anytime, iPostal, postscan
  label      String
  rangeStart Int
  rangeEnd   Int
  isActive   Boolean @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// ── Customer Documents (ID Scans) ────────────────────────────────────────

model CustomerDocument {
  id            String  @id @default(cuid())
  customerId    String
  type          String  // primary_id, secondary_id
  idTypeName    String  // e.g. "drivers_license", "passport"
  fileName      String
  fileUrl       String?
  extractedData String? // JSON: { fullName, address, idNumber, ... }
  expirationDate DateTime?
  uploadedAt    DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ── Mailbox Service Agreement ────────────────────────────────────────────

model MailboxAgreementTemplate {
  id        String  @id @default(cuid())
  name      String
  content   String  // Rich text / template with placeholders
  isDefault Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CustomerAgreement {
  id               String   @id @default(cuid())
  customerId       String
  templateId       String
  signedAt         DateTime?
  signatureDataUrl String?
  status           String   @default("draft") // draft, sent, signed, expired
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ── Invitations ──────────────────────────────────────────────────────────────

model Invitation {
  id        String   @id @default(cuid())
  email     String
  role      String   @default("employee") // admin, manager, employee
  status    String   @default("pending")  // pending, accepted, revoked
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  invitedBy String   // User ID of the admin who created the invite
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, tenantId])
}

// ── Feature Flags ────────────────────────────────────────────────────────────

model FeatureFlag {
  id             String   @id @default(cuid())
  key            String   @unique // e.g. "ai-smart-intake"
  name           String   // Human-readable name
  description    String?  // What this feature does
  category       String   @default("general") // ai, packages, operations, compliance, business, platform
  defaultEnabled Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  overrides FeatureFlagOverride[]
}

model FeatureFlagOverride {
  id         String      @id @default(cuid())
  flagId     String
  flag       FeatureFlag @relation(fields: [flagId], references: [id], onDelete: Cascade)
  targetType String      // 'user' | 'tenant'
  targetId   String      // user.id or tenant.id
  enabled    Boolean
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@unique([flagId, targetType, targetId])
}

// ── Multi-Store Support ──────────────────────────────────────────────────────

model Store {
  id        String   @id @default(cuid())
  name      String
  address   String?
  city      String?
  state     String?
  zipCode   String?
  phone     String?
  isDefault Boolean  @default(false)
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  customers Customer[]
  packages  Package[]
}

// ── Subscription Billing ─────────────────────────────────────────────────────

model BillingPlan {
  id            String  @id @default(cuid())
  name          String  // Starter, Pro, Enterprise
  slug          String  @unique // starter, pro, enterprise
  priceMonthly  Float   // Monthly price in dollars
  priceYearly   Float?  // Optional yearly price
  maxMailboxes  Int     @default(100)
  maxUsers      Int     @default(5)
  maxStores     Int     @default(1)
  features      String? // JSON array of feature strings
  isActive      Boolean @default(true)
  sortOrder     Int     @default(0)
  stripePriceId String? // Stripe Price ID if synced
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  subscriptions Subscription[]
}

model Subscription {
  id                   String   @id @default(cuid())
  tenantId             String
  tenant               Tenant   @relation(fields: [tenantId], references: [id])
  planId               String
  plan                 BillingPlan @relation(fields: [planId], references: [id])
  status               String   @default("active") // active, canceled, past_due, trialing, manual
  billingCycle         String   @default("monthly") // monthly, yearly
  currentPeriodStart   DateTime @default(now())
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean  @default(false)
  stripeSubscriptionId String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model PaymentRecord {
  id              String    @id @default(cuid())
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  amount          Float
  currency        String    @default("usd")
  status          String    @default("succeeded") // succeeded, failed, pending, refunded
  method          String    @default("stripe") // stripe, manual, check, wire
  description     String?
  stripePaymentId String?
  stripeInvoiceId String?   // Stripe Invoice ID for reconciliation
  invoiceUrl      String?
  billingPeriod   String?   // "YYYY-MM" for monthly subscription billing (idempotency key)
  periodStart     DateTime? // Start of the billing period
  periodEnd       DateTime? // End of the billing period
  createdAt       DateTime  @default(now())

  @@unique([tenantId, billingPeriod], name: "unique_tenant_billing_period")
  @@index([tenantId])
  @@index([billingPeriod])
}

// ── Charge Events (BAR-309) ──────────────────────────────────────────────────

enum ChargeServiceType {
  receiving
  storage
  forwarding
  scanning
  pickup
  disposal
  shipping
  custom
}

enum ChargeEventStatus {
  pending
  posted
  invoiced
  paid
  void
  disputed
}

model ChargeEvent {
  id          String              @id @default(cuid())
  tenantId    String
  customerId  String
  pmbNumber   String              // Denormalized PMB for fast queries & audit trail

  // Service details
  serviceType ChargeServiceType
  description String
  quantity    Float               @default(1)
  unitRate    Float               @default(0)

  // Financial breakdown: costBasis + markup = totalCharge
  costBasis   Float               @default(0) // Actual cost to CLIENT (COGS)
  markup      Float               @default(0) // Margin applied
  totalCharge Float               @default(0) // Final customer-facing amount

  // Status & lifecycle
  status      ChargeEventStatus   @default(pending)

  // Optional references to source entities
  packageId   String?             // FK → Package that triggered this charge
  shipmentId  String?             // FK → Shipment that triggered this charge
  mailPieceId String?             // FK → MailPiece that triggered this charge
  invoiceId   String?             // FK → Invoice once invoiced

  // Audit trail
  createdById String?             // User who created this charge
  voidedById  String?             // User who voided this charge
  voidedAt    DateTime?
  voidReason  String?
  notes       String?

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  customer    Customer            @relation(fields: [customerId], references: [id])

  @@index([tenantId])
  @@index([customerId])
  @@index([pmbNumber])
  @@index([status])
  @@index([serviceType])
  @@index([createdAt])
}

// ── Checkout Transactions ────────────────────────────────────────────────────

model CheckoutTransaction {
  id            String   @id @default(cuid())
  customerId    String
  employeeId    String   // Staff who performed checkout
  invoiceNumber String   @unique

  // Fee breakdown
  storageFees   Float    @default(0)
  receivingFees Float    @default(0)
  quotaFees     Float    @default(0)
  addOnFees     Float    @default(0)
  subtotal      Float    @default(0)
  taxRate       Float    @default(0)
  taxAmount     Float    @default(0)
  total         Float    @default(0)

  // Payment
  paymentMethod String   @default("post_to_account") // post_to_account, cash, manual_card, text2pay, tap_to_glass, nfc_reader
  paymentStatus String   @default("pending") // pending, completed, failed, refunded
  paymentRef    String?  // External payment reference ID

  // Packages released in this transaction
  packageIds    String   // JSON array of package IDs
  packageCount  Int      @default(0)

  // Recipient info
  recipientName String?  // If delegate pickup
  recipientIdType   String?
  signatureData String?  // Base64 signature

  // Receipt delivery
  receiptMethod String   @default("none") // email, sms, print, sms+print, none
  receiptSentAt DateTime?

  // Line items detail
  lineItems     String?  // JSON: [{ description, qty, unitPrice, total }]

  createdAt     DateTime @default(now())

  @@index([customerId])
  @@index([employeeId])
}

// ── Legal Documents ──────────────────────────────────────────────────────────

model LegalDocument {
  id          String   @id @default(cuid())
  type        String   // 'terms' or 'privacy'
  content     String   @db.Text // Rich HTML content
  version     Int      @default(1)
  publishedAt DateTime @default(now())
  publishedBy String   // user ID who published
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ── Email Verification Tokens ────────────────────────────────────────────────

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  newEmail  String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
}

// ── Printer Configuration ────────────────────────────────────────────────────

model PrinterConfig {
  id        String   @id @default(cuid())
  tenantId  String
  name      String   @default("ZPL Printer")
  type      String   @default("zpl") // zpl, thermal, laser
  ipAddress String?
  port      Int      @default(9100)
  isDefault Boolean  @default(true)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ── SMS Consent Tracking ─────────────────────────────────────────────────────

model SmsConsent {
  id          String    @id @default(cuid())
  customerId  String
  phone       String
  consentedAt DateTime  @default(now())
  method      String    // 'registration', 'checkbox', 'sms_reply'
  ipAddress   String?
  optedOutAt  DateTime?
  createdAt   DateTime  @default(now())
}

// ── BAR-265: Alert System ──────────────────────────────────────────────────

enum AlertType {
  package
  compliance
  billing
  system
  carrier
  rate
  custom
}

enum AlertPriority {
  urgent_important
  urgent
  important
  completed
}

model Alert {
  id                    String        @id @default(cuid())
  tenantId              String
  type                  AlertType
  priority              AlertPriority
  isTimeSensitive       Boolean       @default(false)
  title                 String
  message               String
  actionUrl             String?       // link to related entity
  relatedEntityType     String?       // 'customer', 'package', 'shipment', etc.
  relatedEntityId       String?
  createdAt             DateTime      @default(now())
  expiresAt             DateTime?
  acknowledgedAt        DateTime?
  acknowledgedBy        String?
  acknowledgementAction String?       // 'skip', 'snooze', 'resolve'
  snoozedUntil          DateTime?
  resolvedAt            DateTime?
  metadata              Json?

  tenant                Tenant        @relation(fields: [tenantId], references: [id])

  @@index([tenantId, resolvedAt])
  @@index([tenantId, priority])
}

// ── Carrier Program Enrollment (BAR-280) ─────────────────────────────────────

model CarrierProgramEnrollment {
  id            String   @id @default(cuid())
  tenantId      String
  program       String   // fedex_hal, ups_access_point
  enabled       Boolean  @default(false)

  // Credentials (encrypted at rest)
  locationId    String?  // Carrier-assigned location ID
  portalUsername String? // Portal login username
  portalPassword String? // Portal login password (encrypted)
  apiKey         String? // API key if direct API integration

  // Configuration
  holdPeriodDays Int     @default(7)     // Default hold period
  warningDaysBefore Int  @default(2)     // Alert N days before expiration
  compensationRate Float @default(0)     // Per-package fee from carrier ($)
  maxCapacity    Int     @default(0)     // Max packages to hold (0 = unlimited)

  // Integration mode
  integrationMode String @default("manual") // manual, portal_auto, api_direct

  // Status tracking
  enrollmentStatus String @default("pending") // pending, active, suspended, terminated
  enrolledAt      DateTime?
  lastSyncAt      DateTime?
  lastSyncStatus  String?  // success, failed, partial

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  checkouts CarrierProgramCheckout[]

  @@unique([tenantId, program])
  @@index([tenantId])
}

// ── Carrier Program Checkout Records (BAR-282, BAR-283) ──────────────────────

model CarrierProgramCheckout {
  id              String   @id @default(cuid())
  enrollmentId    String
  packageId       String
  trackingNumber  String

  // Recipient
  recipientName   String
  recipientIdType String   // drivers_license, passport, military_id, state_id, other
  recipientIdVerified Boolean @default(false)
  idVerifiedAt    DateTime?
  idVerifiedBy    String?  // Employee who verified ID

  // Checkout details
  checkedOutAt    DateTime @default(now())
  checkedOutById  String   // Employee who performed checkout
  signatureData   String?  // Base64 signature

  // Carrier upload status
  uploadStatus    String   @default("pending") // pending, uploaded, confirmed, failed
  uploadedAt      DateTime?
  uploadAttempts  Int      @default(0)
  uploadError     String?
  carrierConfirmation String? // Confirmation ID from carrier

  // Batch tracking
  batchId         String?  // Groups checkouts uploaded together

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  enrollment CarrierProgramEnrollment @relation(fields: [enrollmentId], references: [id])

  @@index([enrollmentId])
  @@index([uploadStatus])
  @@index([batchId])
}

// ── Storage Locations (BAR-326) ──────────────────────────────────────────────

model StorageLocation {
  id        String  @id @default(cuid())
  tenantId  String
  name      String  // e.g. "Shelf A1", "Back Room Bin 3"
  sortOrder Int     @default(0) // For drag-to-reorder
  isDefault Boolean @default(false) // Default location for new packages
  isActive  Boolean @default(true)  // Soft-delete / deactivate

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, isActive])
  @@index([tenantId, sortOrder])
}

// ── BAR-305: Billing Model Configuration ─────────────────────────────────────

/// Per-tenant billing model configuration.
/// Defines which billing models are enabled and their global settings.
model BillingModelConfig {
  id       String @id @default(cuid())
  tenantId String @unique

  // Which models are enabled (can combine all three)
  subscriptionEnabled  Boolean @default(true)
  usageBasedEnabled    Boolean @default(false)
  timeOfServiceEnabled Boolean @default(false)

  // Subscription defaults
  defaultBillingCycle      String  @default("monthly") // monthly, quarterly, yearly
  allowMidCycleChanges     Boolean @default(true)
  prorateUpgrades          Boolean @default(true)
  prorateDowngrades        Boolean @default(true)
  autoRenew                Boolean @default(true)
  gracePeriodDays          Int     @default(7) // Days after failed payment before suspension

  // Usage-based defaults
  usageResetCycle       String  @default("monthly") // monthly, weekly, daily
  usageAlertThreshold   Int     @default(80) // % of quota to trigger alert
  overage               String  @default("charge") // charge, block, alert_only
  usageInvoiceCycle     String  @default("monthly") // When to invoice usage: monthly, weekly, realtime

  // Time-of-service defaults
  tosDefaultMode        String  @default("immediate") // immediate, deferred
  tosPaymentWindow      Int     @default(30) // Days to pay if deferred
  tosAutoInvoice        Boolean @default(true) // Auto-generate invoice at time of service

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

/// Defines a metered usage type with rate tiers.
/// E.g. "Package Scans", "SMS Notifications", "AI Requests"
model UsageMeter {
  id       String @id @default(cuid())
  tenantId String

  name        String  // Human-readable name: "Package Scans", "SMS Notifications"
  slug        String  // URL-safe key: "package_scans", "sms_notifications"
  unit        String  @default("unit") // unit, scan, message, request, gb, hour
  description String?

  // Rate tiers (JSON array, evaluated in order):
  // [{ "upTo": 100, "rate": 0 }, { "upTo": 500, "rate": 0.10 }, { "upTo": null, "rate": 0.05 }]
  rateTiers String @default("[]")

  // Quota & alerts
  includedQuantity Int     @default(0) // Free units included in subscription
  hardLimit        Int     @default(0) // 0 = unlimited
  isActive         Boolean @default(true)
  sortOrder        Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  records UsageRecord[]

  @@unique([tenantId, slug])
  @@index([tenantId])
}

/// Individual usage event / record for metered billing.
model UsageRecord {
  id       String @id @default(cuid())
  meterId  String
  tenantId String

  customerId String? // Null for tenant-level usage (e.g. AI scans)
  quantity   Float   @default(1)
  unitCost   Float   @default(0) // Calculated cost at time of recording
  metadata   String? // JSON: extra context (e.g. { "packageId": "..." })

  // Billing period for aggregation
  period    String // YYYY-MM or YYYY-WW
  invoiced  Boolean  @default(false) // Whether this has been invoiced
  invoiceId String?

  recordedAt DateTime @default(now())

  meter UsageMeter @relation(fields: [meterId], references: [id])

  @@index([meterId, period])
  @@index([tenantId, period])
  @@index([customerId, period])
}

/// Per-customer billing profile with model overrides.
/// Allows different customers to be on different billing models.
model CustomerBillingProfile {
  id         String @id @default(cuid())
  customerId String @unique

  // Which billing models apply to THIS customer (overrides tenant default)
  billingModel String @default("subscription") // subscription, usage, tos, subscription+usage, subscription+tos, all

  // Subscription overrides
  customPlanId  String? // Override tenant's default plan
  customRate    Float?  // Custom monthly rate (overrides plan price)
  billingCycle  String? // Override: monthly, quarterly, yearly

  // Usage overrides
  customUsageCap Int? // Override meter hard limits
  usageDiscount  Float? // % discount on usage charges

  // Time-of-service overrides
  tosMode         String? // Override: immediate, deferred
  creditLimit     Float   @default(0) // Max deferred balance allowed
  accountBalance  Float   @default(0) // Current outstanding balance
  paymentTermDays Int?    // Override tenant's default payment window

  // Auto-pay
  autoPayEnabled Boolean @default(false)
  autoPayDay     Int?    // Day of month for auto-pay (1-28)

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id])
}

/// Time-of-service charge / transaction
model TosCharge {
  id         String @id @default(cuid())
  tenantId   String
  customerId String

  description  String  // "Package Storage Fee", "Shipping Label", etc.
  amount       Float
  tax          Float   @default(0)
  total        Float   // amount + tax
  status       String  @default("pending") // pending, authorized, paid, invoiced, void, refunded, failed
  mode         String  @default("immediate") // immediate, deferred

  // Payment info (if immediate)
  paymentMethod   String? // card, ach, paypal, cash, post_to_account
  paymentMethodId String? // FK → PaymentMethod
  paymentRef      String? // External payment reference
  paidAt          DateTime?

  // Retry tracking (for failed immediate charges)
  retryCount    Int     @default(0)
  lastRetryAt   DateTime?
  failureReason String?

  // Invoice info (if deferred)
  invoiceId String?
  dueDate   DateTime?

  // Reference to what generated this charge
  referenceType  String? // package, shipment, service, custom
  referenceId    String?
  chargeEventId  String? // FK → ChargeEvent

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, customerId])
  @@index([customerId, status])
  @@index([tenantId, status])
  @@index([tenantId, mode, status])
}

// ── Payment Methods (BAR-306) ────────────────────────────────────────────────

/// Stored payment method for a customer (card, ACH, PayPal).
model PaymentMethod {
  id         String @id @default(cuid())
  tenantId   String
  customerId String

  type        String  // card, ach, paypal
  label       String  // "Visa ****4242", "Bank of America ****1234", "PayPal john@..."
  isDefault   Boolean @default(false)

  // Card fields (masked)
  cardBrand   String?  // visa, mastercard, amex, discover
  cardLast4   String?  // Last 4 digits
  cardExpMonth Int?
  cardExpYear  Int?

  // ACH fields (masked)
  bankName    String?
  accountLast4 String?
  routingLast4 String?

  // PayPal
  paypalEmail String?

  // External reference
  externalId  String?  // Stripe payment method ID, PayPal billing agreement ID, etc.

  // Status
  status      String  @default("active") // active, expired, removed
  verifiedAt  DateTime?
  expiryAlertSent Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, customerId])
  @@index([customerId, isDefault])
}

// ── Invoice Line Items (BAR-306) ─────────────────────────────────────────────

/// Individual line item on an invoice.
model InvoiceLineItem {
  id        String @id @default(cuid())
  invoiceId String

  description   String
  serviceType   String?  // receiving, storage, shipping, etc.
  quantity      Float    @default(1)
  unitPrice     Float    @default(0)
  amount        Float    // quantity * unitPrice
  chargeEventId String?  // FK → ChargeEvent
  tosChargeId   String?  // FK → TosCharge

  sortOrder Int @default(0)

  createdAt DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

// ── Invoice Schedule (BAR-306) ───────────────────────────────────────────────

/// Configurable invoicing schedule per tenant or customer.
model InvoiceSchedule {
  id         String  @id @default(cuid())
  tenantId   String
  customerId String? // Null = tenant-wide default; set = customer override

  frequency  String  @default("monthly") // weekly, biweekly, monthly, on_demand
  dayOfWeek  Int?    // 0=Sun..6=Sat (for weekly/biweekly)
  dayOfMonth Int?    // 1-28 (for monthly)
  isActive   Boolean @default(true)
  lastRunAt  DateTime?
  nextRunAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, customerId])
  @@index([tenantId])
  @@index([nextRunAt, isActive])
}

// ── Return to Sender (BAR-321) ───────────────────────────────────────────────

/// Reason why a package or mail piece is being returned to sender.
enum RtsReason {
  no_matching_customer
  closed_pmb
  expired_pmb
  customer_request
  storage_policy_expiry
  refused
  unclaimed
  other
}

/// Processing step the RTS item is currently at.
enum RtsStep {
  initiated       // Marked for RTS
  label_printed   // RTS label generated / printed
  carrier_handoff // Handed off to carrier for return
  completed       // Confirmed returned (carrier scan or manual)
  cancelled       // RTS cancelled (e.g. customer claimed package before handoff)
}

/// Tracks Return-to-Sender actions for packages and mail pieces.
/// Every status change is also recorded in AuditLog for USPS compliance.
model ReturnToSender {
  id        String  @id @default(cuid())
  tenantId  String

  // Polymorphic reference: exactly one of these should be set
  packageId   String?
  mailPieceId String?

  // RTS metadata
  reason       RtsReason
  reasonDetail String?    // Free-text elaboration (e.g. "PMB expired 2026-01-15")
  step         RtsStep    @default(initiated)

  // Carrier-specific return info
  carrier            String?  // usps, fedex, ups, dhl, other
  returnTrackingNumber String? // Tracking number for the return shipment
  carrierNotes       String?  // Carrier-specific procedures / notes

  // Timestamps for each processing step
  initiatedAt     DateTime  @default(now())
  labelPrintedAt  DateTime?
  carrierHandoffAt DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?

  // Who performed each step
  initiatedById     String
  labelPrintedById  String?
  carrierHandoffById String?
  completedById     String?
  cancelledById     String?
  cancelReason      String?

  // Customer reference (denormalised for reporting when PMB is closed)
  customerId  String?
  pmbNumber   String?  // Snapshot at time of RTS

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([step])
  @@index([reason])
  @@index([packageId])
  @@index([mailPieceId])
  @@index([tenantId, step])
  @@index([tenantId, createdAt])
}

// ── BAR-307: PMB Plan Features ──────────────────────────────────────────────

/// PMB subscription plan tiers with annual/monthly pricing and service quotas.
/// CLIENTs define these tiers; CUSTOMERs subscribe.
model PmbPlanTier {
  id       String @id @default(cuid())
  tenantId String

  name        String  // e.g. "Bronze", "Silver", "Gold", "Platinum"
  slug        String  // URL-safe identifier: "bronze", "silver"
  description String?

  // Pricing
  priceMonthly Float            // Monthly rate
  priceAnnual  Float            // Annual rate (discounted)
  annualDiscountPct Float @default(0) // Display discount %: e.g. 17 = 17% off monthly

  // Service quotas included
  includedMailItems    Int @default(30)  // Mail items per cycle
  includedScans        Int @default(5)   // Scan pages per cycle
  freeStorageDays      Int @default(30)  // Free package storage days
  includedForwarding   Int @default(0)   // Forwarding per cycle
  includedShredding    Int @default(0)   // Shredding per cycle
  maxRecipients        Int @default(1)   // Max PMB recipients
  maxPackagesPerMonth  Int @default(0)   // 0 = unlimited

  // Overage rates (inline for simple cases)
  overageMailRate       Float @default(0.50)
  overageScanRate       Float @default(1.00)
  overageStorageRate    Float @default(0.50)
  overageForwardingRate Float @default(2.00)
  overagePackageRate    Float @default(2.00)

  // Config
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customerAddOns PmbCustomerAddOn[]
  promoRedemptions PromoRedemption[]

  @@unique([tenantId, slug])
  @@index([tenantId, isActive])
}

/// Optional add-on services beyond base plan.
model PmbAddOn {
  id       String @id @default(cuid())
  tenantId String

  name        String  // e.g. "Extra Scanning Package", "Priority Forwarding"
  slug        String
  description String?
  priceMonthly Float  // Monthly add-on price
  priceAnnual  Float? // Optional annual price
  unit         String @default("month") // month, item, scan, etc.

  // What the add-on provides
  quotaType  String? // mail, scans, storage, forwarding, shredding, packages
  quotaAmount Int     @default(0) // Additional quota provided

  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customerAddOns PmbCustomerAddOn[]

  @@unique([tenantId, slug])
  @@index([tenantId])
}

/// Tracks a CUSTOMER's active add-on subscriptions.
model PmbCustomerAddOn {
  id         String @id @default(cuid())
  tenantId   String
  customerId String
  addOnId    String
  planTierId String? // The plan tier the customer is on when add-on was added

  // Billing
  billingCycle String   @default("monthly") // monthly, annual
  price        Float    // Actual price charged (may differ from add-on list price if prorated)
  prorated     Boolean  @default(false)
  proratedFrom DateTime?
  activatedAt  DateTime @default(now())
  deactivatedAt DateTime?
  status       String   @default("active") // active, cancelled, expired

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  addOn    PmbAddOn      @relation(fields: [addOnId], references: [id])
  planTier PmbPlanTier?  @relation(fields: [planTierId], references: [id])

  @@index([tenantId, customerId])
  @@index([customerId, status])
}

/// Tracks per-customer quota consumption within a billing cycle.
model PmbQuotaUsage {
  id         String @id @default(cuid())
  tenantId   String
  customerId String

  // Billing period
  periodStart DateTime
  periodEnd   DateTime
  period      String   // "YYYY-MM" format

  // Consumption counters
  mailItemsUsed     Int @default(0)
  scansUsed         Int @default(0)
  storageDaysUsed   Int @default(0)
  forwardingUsed    Int @default(0)
  shreddingUsed     Int @default(0)
  packagesReceived  Int @default(0)

  // Included quotas (snapshot from plan at period start)
  mailItemsIncluded    Int @default(0)
  scansIncluded        Int @default(0)
  storageDaysIncluded  Int @default(0)
  forwardingIncluded   Int @default(0)
  shreddingIncluded    Int @default(0)
  packagesIncluded     Int @default(0)

  // Overage tracking
  overageCharged Float   @default(0)
  overageInvoiced Boolean @default(false)

  // Alert tracking
  alertSentAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, customerId, period])
  @@index([tenantId, period])
  @@index([customerId])
}

/// Promotional pricing codes.
model PromoCode {
  id       String @id @default(cuid())
  tenantId String

  code        String  // e.g. "WELCOME20", "SUMMER2026"
  description String?

  // Discount configuration
  discountType   String  // percent, fixed_amount, free_months
  discountValue  Float   // 20 for 20%, $10 for fixed, 2 for 2 months free
  discountAppliesTo String @default("all") // all, monthly, annual, specific_tier

  // Validity
  startsAt  DateTime @default(now())
  expiresAt DateTime?
  maxRedemptions Int @default(0) // 0 = unlimited
  maxPerCustomer Int @default(1) // How many times a single customer can use it

  // Scope
  applicableTierSlugs String? // JSON array of tier slugs, null = all tiers

  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  redemptions PromoRedemption[]

  @@unique([tenantId, code])
  @@index([tenantId, isActive])
  @@index([code])
}

/// Tracks promo code redemptions.
model PromoRedemption {
  id          String @id @default(cuid())
  promoCodeId String
  tenantId    String
  customerId  String
  planTierId  String?

  // Applied discount
  discountAmount Float  // Actual dollar amount discounted
  billingCycle   String // monthly, annual

  // Lifecycle
  appliedAt    DateTime @default(now())
  expiresAt    DateTime? // When the promo benefit expires
  status       String   @default("active") // active, expired, revoked

  createdAt DateTime @default(now())

  promoCode PromoCode    @relation(fields: [promoCodeId], references: [id])
  planTier  PmbPlanTier? @relation(fields: [planTierId], references: [id])

  @@index([promoCodeId])
  @@index([tenantId, customerId])
}

/// Franchise group — multi-location management entity.
model FranchiseGroup {
  id   String @id @default(cuid())
  name String // Franchise name e.g. "PostalPros National"
  slug String @unique

  // Admin contact
  adminEmail String?
  adminName  String?
  phone      String?

  // Default pricing overrides (apply to all locations unless location overrides)
  defaultPricingJson String? // JSON: { "bronze": { priceMonthly: 7.99 }, ... }

  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  locations FranchiseLocation[]
  pricingOverrides FranchisePricingOverride[]
}

/// Links a tenant (location) to a franchise group.
model FranchiseLocation {
  id           String @id @default(cuid())
  franchiseId  String
  tenantId     String @unique // Each tenant belongs to at most one franchise

  // Location-level overrides (null = use franchise default)
  customPricingJson String? // JSON: { "bronze": { priceMonthly: 8.49 }, ... }

  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  franchise FranchiseGroup @relation(fields: [franchiseId], references: [id])

  @@index([franchiseId])
}

/// Per-tier pricing overrides for a franchise group.
/// Allows structured pricing configuration instead of raw JSON.
model FranchisePricingOverride {
  id          String @id @default(cuid())
  franchiseId String
  tierSlug    String // e.g. "bronze", "silver", "gold", "platinum"

  priceMonthly Float? // Override monthly rate for this tier
  priceAnnual  Float? // Override annual rate for this tier

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  franchise FranchiseGroup @relation(fields: [franchiseId], references: [id])

  @@unique([franchiseId, tierSlug])
  @@index([franchiseId])
}


/// BAR-336: Pending Check-In Queue — packages scanned via Smart Intake awaiting clerk approval.
model SmartIntakePending {
  id             String  @id @default(cuid())
  trackingNumber String?
  carrier        String  // amazon, ups, fedex, usps, dhl, lasership, ontrac, other
  senderName     String?
  senderAddress  String?
  recipientName  String?
  pmbNumber      String?
  packageSize    String  @default("medium") // letter, pack, small, medium, large, xlarge
  serviceType    String? // pmb_customer, ipostal, ups_access_point, fedex_hal, kinek, amazon_hub, general_delivery
  confidence     Float   @default(0)

  /// Carrier confidence: high, medium, low
  carrierConfidence String?
  /// Whether tracking number passes validation
  trackingNumberValid Boolean @default(false)
  /// Whether recipient appears to be a business name
  recipientIsBusiness Boolean @default(false)

  /// Approval status: pending, approved, rejected
  status         String  @default("pending")
  /// Clerk who reviewed (null if not yet reviewed)
  reviewedById   String?
  /// Timestamp of approval/rejection
  reviewedAt     DateTime?
  /// Reason for rejection (if rejected)
  rejectionReason String?

  /// Original image reference (base64 thumbnail or URL)
  labelImageUrl  String?
  /// JSON blob of the raw extraction result for audit purposes
  rawExtraction  String?

  /// If approved, the Package.id created from this pending item
  checkedInPackageId String?

  /// Batch scan session grouping (all items from one scan share a batchId)
  batchId        String?

  /// Tenant scoping
  tenantId       String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([status])
  @@index([batchId])
  @@index([tenantId])
  @@index([trackingNumber])
}
